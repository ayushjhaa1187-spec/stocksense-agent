import pytest
import os
import sys
from unittest.mock import MagicMock, patch

# Add src to python path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../src')))

# Use patch context manager to mock pandas without globally polluting sys.modules
with patch.dict('sys.modules', {'pandas': MagicMock()}):
    from agent import StockSenseAgent

def test_path_traversal_prevention_scan():
    agent = StockSenseAgent()
    with pytest.raises(ValueError, match="Path traversal detected"):
        agent.scan_inventory(inventory_file="../etc/passwd")

def test_path_traversal_prevention_save():
    agent = StockSenseAgent()
    with pytest.raises(ValueError, match="Path traversal detected"):
        agent.save_recommendations({}, output_file="../some_secret_dir/data.json")
