import os
import sys
import unittest
import shutil
from unittest.mock import MagicMock

# Mock pandas before importing agent
sys.modules['pandas'] = MagicMock()

# Add src to python path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../src')))

from agent import StockSenseAgent

class TestPathTraversal(unittest.TestCase):
    def setUp(self):
        self.agent = StockSenseAgent()
        self.exploit_file = "output/../exploit_test.json"
        self.target_path = os.path.abspath("exploit_test.json")

        # Ensure clean state
        if os.path.exists(self.target_path):
            os.remove(self.target_path)

    def tearDown(self):
        if os.path.exists(self.target_path):
            os.remove(self.target_path)

    def test_save_recommendations_traversal(self):
        """Attempt to save recommendations outside the allowed directory."""
        recommendations = {"test": "data"}

        print(f"Attempting to write to: {self.target_path}")

        # We expect a ValueError now
        with self.assertRaises(ValueError):
            self.agent.save_recommendations(recommendations, self.exploit_file)

        self.assertFalse(os.path.exists(self.target_path), "File should NOT exist if vulnerability is fixed")
        print("Vulnerability successfully mitigated.")

if __name__ == '__main__':
    unittest.main()
